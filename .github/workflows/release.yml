name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Extract version info
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}

          # Determine if this is a prerelease
          if [[ "$VERSION" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            # Extract prerelease type (alpha, beta, rc)
            PRERELEASE_TYPE=$(echo "$VERSION" | sed 's/.*-\([a-z]*\).*/\1/')
            echo "prerelease_type=$PRERELEASE_TYPE" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "prerelease_type=" >> $GITHUB_OUTPUT
          fi

          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          TAG_NAME=${{ steps.version.outputs.tag }}
          VERSION=${{ steps.version.outputs.version }}
          PRERELEASE=${{ steps.version.outputs.prerelease }}
          PRERELEASE_TYPE=${{ steps.version.outputs.prerelease_type }}

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 $TAG_NAME^ 2>/dev/null || echo "")

          # Build release notes
          NOTES="## What's Changed\n\n"

          if [ -n "$PREV_TAG" ]; then
            # Get commits since last tag
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..$TAG_NAME --no-merges 2>/dev/null || echo "")
            if [ -n "$COMMITS" ]; then
              NOTES+="$COMMITS\n\n"
            fi
          fi

          # Add installation instructions
          if [ "$PRERELEASE" == "true" ]; then
            NOTES+="## Installation\n\n"
            NOTES+="\`\`\`bash\n"
            NOTES+="npm install -g ralph-starter@$PRERELEASE_TYPE\n"
            NOTES+="\`\`\`\n\n"
            NOTES+="Or install this specific version:\n\n"
            NOTES+="\`\`\`bash\n"
            NOTES+="npm install -g ralph-starter@$VERSION\n"
            NOTES+="\`\`\`\n"
          else
            NOTES+="## Installation\n\n"
            NOTES+="\`\`\`bash\n"
            NOTES+="npm install -g ralph-starter\n"
            NOTES+="\`\`\`\n"
          fi

          # Write to file (multiline handling)
          echo -e "$NOTES" > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to npm
  publish:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Extract version info
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          if [[ "$VERSION" == *"-"* ]]; then
            echo "npm_tag=beta" >> $GITHUB_OUTPUT
          else
            echo "npm_tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm
        run: npm publish --tag ${{ steps.version.outputs.npm_tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
