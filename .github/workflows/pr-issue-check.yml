name: PR Issue Check

on:
  pull_request:
    types: [opened, edited]

jobs:
  check-issue-link:
    name: Check for linked issues
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check PR body for issue references
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Patterns for issue references
            const patterns = [
              /(?:closes|fixes|resolves)\s+#\d+/gi,
              /(?:closes|fixes|resolves)\s+[\w-]+\/[\w-]+#\d+/gi,
              /#\d+/g
            ];

            const hasIssueRef = patterns.some(pattern => pattern.test(prBody));

            if (!hasIssueRef) {
              // Check if we already commented
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });

              const botComment = comments.data.find(c =>
                c.user.type === 'Bot' &&
                c.body.includes('<!-- pr-issue-check -->')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `<!-- pr-issue-check -->
            ### ðŸ’¡ Issue Linking Reminder

            This PR doesn't appear to have a linked issue. Consider linking to:

            - **This repo**: \`Closes #123\`
            - **ralph-ideas**: \`Closes rubenmarcus/ralph-ideas#123\`

            Using \`Closes\`, \`Fixes\`, or \`Resolves\` will auto-close the issue when this PR is merged.

            ---
            *If this PR doesn't need an issue, you can ignore this message.*`
                });
              }
            }
